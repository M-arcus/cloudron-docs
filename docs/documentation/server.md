# Server

## Disk layout

Most of the Cloudron code and data is sandboxed in `/home/yellowtent` (For the curious,
`yellowtent` was the code name for Cloudron). The subdirectories are:

* `box` - This contains the Cloudron code. The Cloudron code does not run as root.
* `boxdata` - This contains data that is generated by the Cloudron code including certs
* `appsdata` - This contains the data generated by each app. Each directory here corresponds
  to the application id.
* `platformdata` - This contains 'runtime' data of the platform for mysql, postgres,
  mongodb, nginx. This also contains all user emails in the `mail/vmail` directory.

The other important locations on the server are:

* `/var/lib/docker` - This contains docker images
* `/etc/nginx` - These contains the reverse proxy configuration. It is not meant to be edited manually.
* `/apps.swap` - This is a swap file that is dynamically resized by Cloudron. It will be no more than 4GB.

## Using overlay2 backend for Docker

Please make sure you have a [complete backup](/documentation/backups/#making-a-complete-backup) before
following the procedure below.

Cloudron uses the `devicemapper` storage backend for Docker. This backend is very slow when used with non-SSD disks (HDD).
Changing the docker storage backend to `overlay2` greatly speeds things up. This can be done as follows:

* Cleanup docker
```
systemctl stop box
systemctl stop docker
rm -rf /var/lib/docker
```

* Change the backend setting
```
vi /etc/systemd/system/docker.service.d/cloudron.conf
# change --storage-driver=devicemapper to --storage-driver=overlay2
```

* Make Cloudron code re-pull all images. Edit `/home/yellowtent/platformdata/INFRA_VERSION` and change the minor version
in the "version" field. For example, if it is 48.3.0, change it to 48.2.0.

**NOTE:** Do not change the major version field since it will try to restore from a backup.

```
systemctl daemon-reload
systemctl start docker
docker network create --subnet=172.18.0.0/16 cloudron
systemctl restart cloudron.target # this will download images all over, so give it some time
```

## Move the data directory to another location

Please make sure you have a [complete backup](/documentation/backups/#making-a-complete-backup) before
following the procedure below.

Apps store their data under `/home/yellowtent/appsdata`. If the server is running out of disk space,
this directory can be moved to another ext4 disk/location as follows:

```
    systemctl stop cloudron.target
    systemctl stop docker
    DATA_DIR="/var/data"  # this is the new location for appsdata
    mkdir -p "${DATA_DIR}"
    mv /home/yellowtent/appsdata "${DATA_DIR}"
    ln -s "${DATA_DIR}/appsdata" /home/yellowtent/appsdata

    # (optional) move out app database storage to the external disk
    mv /home/yellowtent/platformdata "${DATA_DIR}"
    ln -s "${DATA_DIR}/platformdata" /home/yellowtent/platformdata

    systemctl start docker
    systemctl start cloudron.target
```

If the disk graph does not display properly, do a `systemctl restart collectd`.

**Note**: data directory must be an `ext4` filesystem.

## Resizing the server

For VPS providers that support it, the server (cpu/disk/memory) can be resized and
Cloudron will automatically adapt to the available resources after a server restart.


## Securing SSH access

It is highly recommended to disable password based access to your server since many online
attackers brute force passwords. Configuring SSH access to be based on a SSH key secures
the server with the equivalent of a 634 length password with random letters and numbers.

To disable password authentication, check for the following line in `/etc/ssh/sshd_config`:
```
PasswordAuthentication no
```

By default, the SSH server runs on port 22. We recommend moving this to port 202 to prevent
brute force attacks. To do so, change the following line in `/etc/ssh/sshd_config`:
```
Port 202   # Do not use any other port. Only this port is not blocked by the Cloudron firewall
```

The SSH service can be restarted using `systemctl restart sshd`.

## Debugging

You can SSH into your Cloudron and collect logs:

* `journalctl -a -u box` to get debug output of box related code.
* `docker ps` will give you the list of containers. The addon containers are named as `mail`, `postgresql`,
   `mysql` etc. If you want to get a specific container's log output, `journalctl -a CONTAINER_ID=<container_id>`.

## Health check monitor

You will have to setup a 3rd party service like [Cloud Watch](https://aws.amazon.com/cloudwatch/) or
[UptimeRobot](http://uptimerobot.com/) to monitor the Cloudron itself. You can use
`https://my.<domain>/api/v1/cloudron/status` as the health check URL.

## Email Notifications

The Cloudron will notify the Cloudron administrator via email if apps go down, run out of memory,
low disk space, have updates available etc.

The Cloudron administrators will receive a weekly digest email about all the activities on
the Cloudron. At the time of this writing, the email sends out information about pending and
applied updates.

## Recovery after disk full

One or more system services may go down if the disk becomes full. Once some space has been freed up,
follow the steps below to repair the Cloudron:

### Unbound

Check the status of unbound using:
```
systemctl status unbound
```

It must say `active (running)`. If not, run the following command:
```
unbound-anchor -a /var/lib/unbound/root.key
systemctl restart unbound
```

### Nginx

Check the status of nginx:
```
systemctl status nginx
```

If nginx is not running:
```
systemctl restart nginx
```

### Docker

Docker can be restarted using the following command:
```
systemctl restart docker
```

Note that the above command will restart all the apps and addon services.

### Box

Once the above services are up and running, the box code can be restarted using:
```
systemctl restart box
```

The above command can be run to get new certificates for the web admin.

## Identifying the container of an app

Cloudron creates app containers with the `location` and `appId` label set. For example,
to find the container id of the app running on the `redmine` subdomain:

```
docker ps -f label=location=redmine
```

## VPS Quirks

#### Kimsufi servers

Be sure to check the "use the distribution kernel" checkbox in the personalized installation mode.

