# Server

## Disk layout

These are the important locations on the server:

* `/var/lib/docker` - This contains docker images
* `/etc/nginx` - These contains the reverse proxy configuration. It is not meant to be edited manually.
* `/apps.swap` - This is a swap file that is dynamically resized by Cloudron. It will be no more than 4GB.

Most of the Cloudron code and data is in `/home/yellowtent` (For the curious, `yellowtent` was the code
name for Cloudron). The subdirectories are:

* `box` - This contains the Cloudron code
* `boxdata` - This contains data that is generated by the Cloudron code including certs
* `appsdata` - This contains the data generated by each app. Each directory here corresponds
  to the application id.
* `platformdata` - This contains 'runtime' data of the platform for mysql, postgres,
  mongodb, nginx. This also contains all user emails in the `mail/vmail` directory.

## Using overlay2 backend for Docker

Cloudron uses the `devicemapper` storage backend for Docker. This backend is very slow when used with non-SSD disks (HDD).
Changing the docker storage backend to `overlay2` greatly speeds things up. This can be done as follows:

* Cleanup docker
```
systemctl stop box
systemctl stop docker
rm -rf /var/lib/docker
```

* Change the backend setting
```
vi /etc/systemd/system/docker.service.d/cloudron.conf
# change --storage-driver=devicemapper to --storage-driver=overlay2
```

* Make Cloudron code re-pull all images. Edit `/home/yellowtent/platformdata/INFRA_VERSION` and change the minor version
in the "version" field. For example, if it is 48.3.0, change it to 48.2.0.

**NOTE:** Do not change the major version field since it will try to restore from a backup.

```
systemctl daemon-reload
systemctl start docker
docker network create --subnet=172.18.0.0/16 cloudron
systemctl restart cloudron.target # this will download images all over, so give it some time
```

## Move the data directory to another location

Cloudron's data directory can be moved from `/home/yellowtent/appsdata` to a new location `DATA_DIR`
as follows:

```
    systemctl stop cloudron.target
    systemctl stop docker
    DATA_DIR="/var/data"  # this is the new location
    mkdir -p "${DATA_DIR}"
    mv /home/yellowtent/appsdata "${DATA_DIR}"
    ln -s "${DATA_DIR}/appsdata" /home/yellowtent/appsdata
    mv /home/yellowtent/platformdata "${DATA_DIR}"
    ln -s "${DATA_DIR}/platformdata" /home/yellowtent/platformdata
    systemctl start docker
    systemctl start cloudron.target
```

If the disk graph does not display properly, do a `systemctl restart collectd`.

**Note**: data directory must be an `ext4` filesystem.

## Resizing the server

For VPS providers that support it, you can simply resize the server (cpu/disk/memory) and Cloudron will
automatically adapt to the available resources after a server restart.

## Debugging

You can SSH into your Cloudron and collect logs:

* `journalctl -a -u box` to get debug output of box related code.
* `docker ps` will give you the list of containers. The addon containers are named as `mail`, `postgresql`,
   `mysql` etc. If you want to get a specific container's log output, `journalctl -a CONTAINER_ID=<container_id>`.

## Kimsufi servers

Be sure to check the "use the distribution kernel" checkbox in the personalized installation mode.

## Health check monitor

You will have to setup a 3rd party service like [Cloud Watch](https://aws.amazon.com/cloudwatch/) or
[UptimeRobot](http://uptimerobot.com/) to monitor the Cloudron itself. You can use
`https://my.<domain>/api/v1/cloudron/status` as the health check URL.

