# Backup, Restore and Migrate

## How Cloudron backups work

Cloudron automatically creates a complete backup of the server every day. Each app is backed up
independently to files with prefix `app_<appid>`. The platform data (users, groups, email, cloudron
configuration) is backed up independently to files with the prefix `box_`.

Unlike VM snapshots, these backups contain only the necessary information to complete re-instate the
Cloudron or app. For example, application code or libraries are not part of a backup since these are
read-only and can never change. Runtime files (lock files, logs) or temporary files generated by apps
are not backed up either. Only the database and app user data is backed up. This design significantly
reduces the size of backups.

Backups are designed for portability. App backups can be used to create a clone of the app or even move
the app to another Cloudron. Platform and app backups together can also be used to move the Cloudron
in it's entirety to another server easily.

By default, backups reside in `/var/backups`. Please note that having backups reside in the same
physical machine as the Cloudron server instance is dangerous and it must be changed to an external
storage location like S3 as soon as possible.

## Making a complete backup

To take a complete backup, click the `Backup now` button in the `Settings` page:

<center>
<img src="/img/backup.png" class="shadow">
</center>

Please be careful that if you have no-op backend, no backups are taken. If your backups
are stored on the same server, be sure to download them before making changes in the server.

## Backup a specific app

## Backing up to Amazon S3

Provide S3 backup credentials in the `Backups` section of the `Settings` page.

<center>
<img src="/img/backups-s3.png" class="shadow">
</center>

When creating the bucket in S3, the bucket can be setup to periodically delete old backups by
adding a lifecycle rule using the AWS console. S3 supports both permanent deletion
or moving objects to the cheaper Glacier storage class based on an age attribute.
With the current daily backup schedule a setting of two days should be sufficient
for most use-cases.

When using root credentials on AWS, follow the instructions [here](http://docs.aws.amazon.com/general/latest/gr/managing-aws-access-keys.html)
to create access keys.

When using IAM, follow the instructions [here](http://docs.aws.amazon.com/IAM/latest/UserGuide/id_users_create.html#id_users_create_console) to create a user and use the following policy to give the user access to the bucket:

```
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Action": "s3:*",
            "Resource": [
                "arn:aws:s3:::<your bucket name>",
                "arn:aws:s3:::<your bucket name>/*"
            ]
        }
    ]
}
```

The `Encryption key` is an arbitrary passphrase used to encrypt the backups. Keep the passphrase safe; it is
required to decrypt the backups when restoring the Cloudron.

## Backing up to Minio

[Minio](https://minio.io/) is a distributed object storage server, providing the same API as Amazon S3.

Minio can be setup, by following the [installation instructions](https://docs.minio.io/) on any server,
which is reachable by the Cloudron. **Do not setup Minio on the same server as the Cloudron, this will
inevitably result in data loss, if backups are stored on the same instance.**

Once setup, minio will print the necessary information, like login credentials, region and endpoints in its logs.

```
$ ./minio server ./storage

Endpoint:  http://192.168.10.113:9000  http://127.0.0.1:9000
AccessKey: GFAWYNJEY7PUSLTHYHT6
SecretKey: /fEWk66E7GsPnzE1gohqKDovaytLcxhr0tNWnv3U
Region:    us-east-1
```

First create a new bucket for the backups, using the minio commandline tools or the webinterface. The bucket has to have **read and write** permissions.

<center>
<img src="/img/backups-minio.png" class="shadow">
</center>

The `Encryption key` is an arbitrary passphrase used to encrypt the backups. Keep the passphrase safe; it is
required to decrypt the backups when restoring the Cloudron.

## Backup interval

Cloudron automatically creates a backup every night (in the timezone of your Cloudron).

To instantly make a complete backup, click the `Backup now` button in the `Backups` section of the `Settings` page.
Alternately, use the CLI command `cloudron machine backup create`.

## Migrate Apps from one Cloudron to another

Migrating apps or moving apps from one Cloudron to another works by first creating a new backup of the app on the old Cloudron,
copying the backup tarball onto the new Cloudron's backup storage and then installing a new app, based on the backup on
the new Cloudron.

**Both Cloudrons have to use the same backup encryption key!**

The following step will migrate an app:

* Against the old Cloudron
```
cloudron backup create --app <subdomain/appid>
```
* Copy the new backup from the old Cloudron's backup storage to the new one. This can be done via the s3 webinterface
  or scp if the filesystem backend is used. The backup can be located by its backup ID, which can be seen with:
```
cloudron backup list --app <subdomain/appid>
```
* Make note of the app's appstore id and version from:
```
cloudron list
```
* Then login to the new Cloudron and install the new app based on the created backup:
```
cloudron login <new Cloudron domain>
cloudron install --appstore-id=<apps appstore id>@<specific version if required> --backup <backupId>
```
The backupId usually also includes a path prefix and looks like: `2017-07-17-121412-248/app_2d7f2a6a-4c17-43a6-80bc-0bd47a99727f_2017-07-17-121412-269_v4.1.1.tar.gz`

## Changing the Cloudron domain name

Cloudron's main domain can be changed without losing any data using the following steps.
If you are wary of the steps below, simple take a backup of cloudron (Settings -> Backup)
and restore the Cloudron with a different domain.

1. Edit `/home/yellowtent/configs/cloudron.conf`. It has a field called `fqdn`.
   Change this to the desired domain name.

2. If you use the `wildcard` or `manual` DNS backend, add a DNS `A` record manually
   for `*.example.com` and `example.com` to the server's IP. For, `route53`, `cloudflare`
   and other automated DNS backends, you can skip this step.

3. Edit `/home/yellowtent/platformdata/INFRA_VERSION`. It has a field called `version`.
   Bump the minor version of this field. For example, if the version is a.b.c, change it
   to a.b+1.c. It is important to _not_ change the major version (i.e 'a')

4. `systemctl restart box`

In 5 minutes or so, you should be able to reach `https://my.example.com`.

## Cloning a Cloudron app in same Cloudron

To clone an existing app to a new location within the same Cloudron, use the CLI tool's `clone` command.

To clone the app at location `myfiles` with it's latest backup into a new location `dolly`
use the following commands:

```
$ cloudron clone --app myfiles # create a backup

$ cloudron clone --app myfiles --backup latest # clone from the backup just created
Location: dolly
App cloned as id a426fdec-94e7-42c5-a1f4-ab1a5ac22427

 => Waiting to start installation
 => Registering subdomain
 => Downloading image
 => Download backup and restore addons .......
 => Creating container .
 => Setting up collectd profile
 => Waiting for DNS propagation ....
 => Wait for health check........

App is cloned

```

## Cloning a Cloudron app into another Cloudron

Cloudron app backups are essentially 'snapshots' of the app and are portable across Cloudrons.
To move an app from one Cloudron to another or to instantiate an app from an arbitrary backup
perform the following steps:

1. Make the app backup available in the destination Cloudron's backup directory.

2. Install the app using the following command:
```
cloudron install --backup <id> --appstore-id org.wordpress.cloudronapp@0.9.1
```

## Restoring an app from existing backup

Apps can be restored to a previous backup by clicking on the `Restore` button.

<center>
<img src="/img/app_restore_button.png" class="shadow">
</center>

Select the backup you want to restore to:

<center>
<img src="/img/app-select-backup.png" class="shadow">
</center>

Restoring will also revert the code to the version that was running when the backup was created. This is because the
current version of the app may not be able to handle old data.

## Restoring Cloudron from a backup

To restore a Cloudron from a specific backup:

* Identify the backup id. This can be done by listing the backups in the backup backend.

    * For `S3` backend, use the [AWS console](https://console.aws.amazon.com/s3/) to list the backups.

    * For `Filesystem` backend, list the backup directory. Backups are sorted by time.
      Each backup directory, contains a file with prefix `box_` which contains the
      backup of platform and a number of files with the prefix `app_` that contain the
      application backups.

```
        root@intranet:~# ls -l /var/backups/
        total 8
        drwxr-xr-x 2 yellowtent yellowtent 4096 Sep 25 21:02 2017-09-25-210206-153
        drwxr-xr-x 2 yellowtent yellowtent 4096 Sep 25 21:02 2017-09-25-210210-192
```


* Make the backup accessible to the new server:

    * For `S3` backend - Make the box backup publicly readable. This can be done from the AWS S3
      console. Once the box has restored, it can be made private again.

    * For `Filesystem` backend - Copy the backup files from the old server to the new server.
      Be careful about maintaining the same folder structure for backups in the old and new server.
      Note that only the specific backup needs to be copied. For example, just scp'ing the directory
      `/var/backups/2017-09-25-210210-192` in the above listing is sufficient to restore from the latest
      backup.

* Create a new Cloudron by running the following commands on the new server:

```
        # wget https://cloudron.io/cloudron-setup
        # chmod +x cloudron-setup
        # ./cloudron-setup --provider digitalocean --restore-url file:///var/backups/2017-09-25-210210-192/box_2017-09-25-210211-692_v1.6.5.tar.gz
```

!!! warning
    If backups are encrypted, pass the encryption key in `--encryption-key`.

* Once the installation is complete, navigate to `https://<IP>`. Accept the self-signed cert and finish
  the domain name setup. It is possible to provide a domain that was different from the Cloudron's previous
  domain. If a new domain is provided, all apps are migrated to subdomains of this new domain.

* After providing the domain name details, Cloudron will automatically start restoring all the apps.

## Migrating Cloudron to another server

To migrate to a different server:

* Take a [complete backup](/documentation/backups/#making-a-complete-backup) of the existing
  Cloudron. Click the `Backup now` button in the `Settings` page.

* Follow the steps to [restore from the latest backup](/documentation/backups/#restoring-cloudron-from-a-backup)
  on the new server.

Note that the above migration procedure is required only if you want to migrate
to another server. If the exisitng server's cpu/disk/memory can be resized (as is
the case with most server providers), then resize it and reboot the server.
Cloudron will automatically adapt to the available resources after a server restart.
